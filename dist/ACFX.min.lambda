=LAMBDA(response,[design],[max_lag],LET(nRow,ROWS(response),hasDesign,NOT(ISOMITTED(design)),max_lag_,IF(ISOMITTED(max_lag),12,FLOOR.MATH(max_lag)),REORDER,LAMBDA(beta,LET(m,COLUMNS(beta)-1,INDEX(beta,1,SEQUENCE(m,1,m,-1)))),LINSOLVE,LAMBDA(design_,response_,REORDER(LINEST(response_,design_,0,0))),beta,LINSOLVE(design,response),resid,IF(hasDesign,response-MMULT(design,beta),response),ACF,LAMBDA(lag,CORREL(DROP(resid,lag),DROP(resid,-lag))),IF(IFERROR(nRow<>ROWS(design),FALSE),INDIRECT(""),IF(max_lag_<=0,1+"",MAP(SEQUENCE(max_lag_,1,1),ACF)))))
