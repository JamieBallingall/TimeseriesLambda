=LAMBDA(response,[design],[max_lag],LET(nRow,ROWS(response),max_lag_,IF(ISOMITTED(max_lag),12,FLOOR.MATH(max_lag)),REORDER,LAMBDA(beta,LET(m,COLUMNS(beta)-1,INDEX(beta,1,SEQUENCE(m,1,m,-1)))),LINSOLVE,LAMBDA(design_,response_,REORDER(LINEST(response_,design_,0,0))),ONCE,LAMBDA(lag,LET(staggered,MAKEARRAY(nRow-lag,lag,LAMBDA(iRow,iCol,INDEX(response,iRow+iCol-1))),augDesign,CHOOSE(2*NOT(ISOMITTED(design))+NOT(lag=0)+1,NA(),staggered,DROP(design,lag),HSTACK(DROP(design,lag),staggered)),shiftResp,DROP(response,lag),beta,LINSOLVE(augDesign,shiftResp),resid,IF(ISNA(augDesign),shiftResp,shiftResp-MMULT(augDesign,beta)),CORREL(DROP(resid,1),DROP(resid,-1)))),IF(IFERROR(nRow<>ROWS(design),FALSE),INDIRECT(""),IF(max_lag_<=0,1+"",MAP(SEQUENCE(max_lag_,1,0),ONCE)))))
