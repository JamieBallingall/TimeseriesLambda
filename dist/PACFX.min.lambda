=LAMBDA(design,response,[max_lag],LET(max_lag_,IF(ISOMITTED(max_lag),15,max_lag),nRow,ROWS(response),AUX,LAMBDA(lag,LET(REORDER,LAMBDA(beta,LET(nCols,COLUMNS(beta)-1,INDEX(beta,1,SEQUENCE(nCols,1,nCols,-1)))),LINSOLVE,LAMBDA(design_,response_,REORDER(LINEST(response_,design_,0,0))),staggered,MAKEARRAY(nRow-lag,lag,LAMBDA(iRow,iCol,INDEX(response,iRow+iCol-1))),augDesign,IF(lag=0,design,HSTACK(DROP(design,lag),staggered)),shiftedResponse,DROP(response,lag),beta,LINSOLVE(augDesign,shiftedResponse),resid,shiftedResponse-MMULT(augDesign,beta),CORREL(DROP(resid,1),DROP(resid,-1)))),MAP(SEQUENCE(max_lag_+1,1,0),AUX)))
