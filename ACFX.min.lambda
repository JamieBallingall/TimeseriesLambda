=LAMBDA(design,response,[max_lag],LET(nRow,ROWS(response),max_lag_,IF(ISOMITTED(max_lag),MIN(370,FLOOR.MATH(nRow/2)),FLOOR.MATH(max_lag)),REORDER,LAMBDA(beta,LET(nCols,COLUMNS(beta)-1,INDEX(beta,1,SEQUENCE(nCols,1,nCols,-1)))),LINSOLVE,LAMBDA(design_,response_,REORDER(LINEST(response_,design_,0,0))),beta,LINSOLVE(design,response),resid,IF(ISOMITTED(design),response,response-MMULT(design,beta)),ACF,LAMBDA(lag,CORREL(DROP(resid,lag),DROP(resid,-lag))),IF(AND(NOT(ISOMITTED(design)),nRow<>ROWS(design)),INDIRECT(""),IF(max_lag_<=0,1+"",MAP(SEQUENCE(max_lag_,1,1),ACF)))))
